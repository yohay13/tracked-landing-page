name: Weaver Integration Check

on:
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'

      - name: Install dependencies
        id: install
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.WEAVER_NPM_TOKEN }}

      - name: Type check
        id: typecheck
        run: npm run typecheck || npm run type-check || npx tsc --noEmit

      - name: Lint
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Build
        id: build
        run: npm run build

      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const failedSteps = [];
            if ('${{ steps.install.outcome }}' === 'failure') failedSteps.push('Install dependencies');
            if ('${{ steps.typecheck.outcome }}' === 'failure') failedSteps.push('Type check');
            if ('${{ steps.build.outcome }}' === 'failure') failedSteps.push('Build');

            const body = `## ❌ Weaver Integration Check Failed

            The following step(s) failed:
            ${failedSteps.map(s => `- ${s}`).join('\n')}

            ### Troubleshooting

            **If "Install dependencies" failed:**
            - Ensure \`WEAVER_NPM_TOKEN\` secret is set in Settings → Secrets → Actions
            - The token needs \`read:packages\` scope

            **If "Type check" or "Build" failed:**
            - This may indicate an issue with the generated code
            - Check the workflow logs for specific errors
            - Contact support@weaver.dev with this PR link

            ---
            *This comment was automatically posted by Weaver*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Notify Weaver for auto-fix
        if: failure()
        run: |
          curl -X POST "${{ secrets.WEAVER_API_URL }}/api/webhooks/ci-failure" \
            -H "Content-Type: application/json" \
            -d '{
              "owner": "'${{ github.repository_owner }}'",
              "repo": "'${{ github.event.repository.name }}'",
              "runId": '${{ github.run_id }}',
              "prNumber": '${{ github.event.pull_request.number }}',
              "branch": "'${{ github.head_ref }}'",
              "failedSteps": "'"$FAILED_STEPS"'"
            }' || true
        env:
          FAILED_STEPS: ${{ join(steps.*.outcome == 'failure' && steps.*.name, ',') }}
